{% extends 'dashboard/base.html' %} 
{% load humanize %}
{% load static %}
{% load math_filters %}
{% block content %}
<!-- CSS -->
<link rel="stylesheet" href="{% static 'dashboard/css/analystics.css' %}">

<div class="container-fluid analytics-container">

    <!-- ===== HEADER WITH PERIOD FILTER ===== -->
    <div class="executive-analytics-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="fw-bold mb-2">Multi-Currency Analytics</h1>
                <p class="lead opacity-85 mb-0">
                    Real-time insights across {{ currency_stats|length }} currencies
                    <span class="badge bg-info ms-2">{{ period|upper }} View</span>
                </p>
            </div>
            <div class="col-lg-4 text-lg-end mb-3">
                <!-- Period Filter -->
                <div class="btn-group" role="group">
                    <a href="?period=today" 
                    class="btn btn-sm {% if period == 'today' %}btn-gradient-primary{% else %}btn-outline-gradient{% endif %}">
                    Today
                    </a>
                    <a href="?period=week" 
                    class="btn btn-sm {% if period == 'week' %}btn-gradient-primary{% else %}btn-outline-gradient{% endif %}">
                    Week
                    </a>
                    <a href="?period=month" 
                    class="btn btn-sm {% if period == 'month' %}btn-gradient-primary{% else %}btn-outline-gradient{% endif %}">
                    Month
                    </a>
                    <a href="?period=year" 
                    class="btn btn-sm {% if period == 'year' %}btn-gradient-primary{% else %}btn-outline-gradient{% endif %}">
                    Year
                    </a>
                    <a href="?period=all" 
                    class="btn btn-sm {% if period == 'all' %}btn-gradient-primary{% else %}btn-outline-gradient{% endif %}">
                    All Time
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SUMMARY KPI CARDS (Using old CSS classes) ===== -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="analytics-card-premium animate-fade-in">
                <div class="card-body p-4">
                    <div class="analytics-icon-premium">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <div>
                        <div class="analytics-label-premium">Total Transactions</div>
                        <div class="analytics-value-premium">{{ total_transactions|intcomma }}</div>
                        <div class="small text-muted mt-2">
                            <i class="bi bi-globe me-1"></i>
                            {{ currency_count }} currencies • {{ country_count }} countries
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="gradient-card animate-fade-in delay-1" 
                 style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <div class="icon-bg">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div>
                    <div class="label-sm">Total Sent ({{ base_currency }})</div>
                    <div class="value-lg">{{ total_amount_base|default:0|floatformat:0|intcomma }}</div>
                    <div class="small opacity-85 mt-2">
                        <i class="bi bi-currency-exchange me-1"></i>
                        {{ total_transactions }} transactions
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="gradient-card animate-fade-in delay-2"
                 style="background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);">
                <div class="icon-bg">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div>
                    <div class="label-sm">Total Charges ({{ base_currency }})</div>
                    <div class="value-lg">{{ total_charges_base|default:0|floatformat:0|intcomma }}</div>
                    <div class="small opacity-85 mt-2">
                        <i class="bi bi-percent me-1"></i>
                        Effective rate: {{ overall_charge_rate|floatformat:2 }}%
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="gradient-card animate-fade-in delay-3"
                 style="background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);">
                <div class="icon-bg">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div>
                    <div class="label-sm">Total Net ({{ base_currency }})</div>
                    <div class="value-lg">{{ total_net_base|default:0|floatformat:0|intcomma }}</div>
                    <div class="small opacity-85 mt-2">
                        <i class="bi bi-graph-up me-1"></i>
                        {{ net_to_total_ratio|floatformat:1 }}% of total
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CURRENCY BREAKDOWN GRID ===== -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="chart-container-premium">
                <div class="chart-header d-flex justify-content-between align-items-center">
                    <h5>
                        <i class="bi bi-currency-exchange me-2"></i>
                        Currency Breakdown
                    </h5>
                    <span class="badge bg-info">{{ currency_stats|length }} Currencies Active</span>
                </div>
                
                <div class="row g-3">
                    {% for stat in currency_stats %}
                    <div class="col-xl-3 col-lg-4 col-md-6">
                        <div class="currency-card premium-card">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <div class="d-flex align-items-center">
                                        <div class="currency-symbol" style="background: {{ stat.color }};">
                                            {{ stat.symbol|default:stat.currency|slice:":1" }}
                                        </div>
                                        <div class="ms-2">
                                            <h6 class="fw-bold mb-0">{{ stat.currency }}</h6>
                                            <small class="text-muted">{{ stat.currency_name }}</small>
                                        </div>
                                    </div>
                                </div>
                                <span class="badge {% if stat.percentage > 50 %}bg-primary{% elif stat.percentage > 20 %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ stat.percentage|floatformat:1 }}%
                                </span>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="small text-muted">Transactions</div>
                                    <div class="fw-bold">{{ stat.count|intcomma }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">Avg. Value</div>
                                    <div class="fw-bold">{{ stat.avg_amount|floatformat:0|intcomma }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">Total Sent</div>
                                    <div class="fw-bold">{{ stat.total_amount|floatformat:0|intcomma }} {{ stat.currency }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">Charges</div>
                                    <div class="fw-bold {% if stat.charge_rate > 5 %}text-danger{% endif %}">
                                        {{ stat.total_charge|floatformat:0|intcomma }} {{ stat.currency }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">Charge Rate</small>
                                    <small class="fw-semibold {% if stat.charge_rate > 5 %}text-danger{% endif %}">
                                        {{ stat.charge_rate|floatformat:2 }}%
                                    </small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" 
                                         style="width: {{ stat.charge_rate|floatformat:0 }}%;
                                                background: {{ stat.color }};"></div>
                                </div>
                            </div>
                            
                            <div class="mt-2 small text-muted">
                                <i class="bi bi-arrow-left-right me-1"></i>
                                1 {{ stat.currency }} = {{ stat.exchange_rate|floatformat:2 }} {{ base_currency }}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="alert alert-info text-center py-5">
                            <i class="bi bi-currency-exchange fs-1 d-block mb-3"></i>
                            <h5>No Transaction Data</h5>
                            <p class="mb-0">Start by creating transactions in different currencies</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ===== DYNAMIC CHARTS ===== -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="chart-container-premium">
                <div class="chart-header">
                    <h5><i class="bi bi-bar-chart-line me-2"></i> Transaction Volume by Currency</h5>
                </div>
                <div class="chart-wrapper">
                    <canvas id="currencyVolumeChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="chart-container-premium">
                <div class="chart-header">
                    <h5><i class="bi bi-pie-chart me-2"></i> Distribution by Value ({{ base_currency }})</h5>
                </div>
                <div class="chart-wrapper">
                    <canvas id="valueDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== DETAILED CURRENCY TABLE ===== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container-premium">
                <div class="chart-header">
                    <h5><i class="bi bi-table me-2"></i> Detailed Currency Analysis</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle analytics-table">
                        <thead class="table-light">
                            <tr>
                                <th>Currency</th>
                                <th class="text-end">Transactions</th>
                                <th class="text-end">Total Sent</th>
                                <th class="text-end">In {{ base_currency }}</th>
                                <th class="text-end">Charges</th>
                                <th class="text-end">Charge Rate</th>
                                <th class="text-end">Avg. Value</th>
                                <th class="text-end">Contribution</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in currency_stats %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="currency-dot me-2" style="background: {{ stat.color }};"></div>
                                        <div>
                                            <strong>{{ stat.currency }}</strong>
                                            <div class="small text-muted">{{ stat.currency_name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">{{ stat.count|intcomma }}</td>
                                <td class="text-end">
                                    {{ stat.total_amount|floatformat:0|intcomma }} {{ stat.currency }}
                                </td>
                                <td class="text-end fw-bold text-success">
                                    {{ stat.base_amount|floatformat:0|intcomma }}
                                </td>
                                <td class="text-end {% if stat.charge_rate > 5 %}text-danger{% endif %}">
                                    {{ stat.total_charge|floatformat:0|intcomma }}
                                </td>
                                <td class="text-end">
                                    <span class="badge {% if stat.charge_rate > 5 %}bg-danger{% elif stat.charge_rate > 2 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ stat.charge_rate|floatformat:2 }}%
                                    </span>
                                </td>
                                <td class="text-end">{{ stat.avg_amount|floatformat:0|intcomma }}</td>
                                <td class="text-end">
                                    <div class="progress-thin">
                                        <div class="progress-thin-bar" 
                                             style="width: {{ stat.percentage }}%;
                                                    background: {{ stat.color }};">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ stat.percentage|floatformat:1 }}%</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-active">
                            <tr class="fw-semibold">
                                <th>TOTAL</th>
                                <th class="text-end">{{ total_transactions|intcomma }}</th>
                                <th class="text-end">—</th>
                                <th class="text-end text-primary">{{ total_amount_base|floatformat:0|intcomma }}</th>
                                <th class="text-end text-danger">{{ total_charges_base|floatformat:0|intcomma }}</th>
                                <th class="text-end">{{ overall_charge_rate|floatformat:2 }}%</th>
                                <th class="text-end">
                                    {% if total_transactions > 0 %}
                                        {{ total_amount_base|floatformat:0|intdivide:total_transactions|intcomma }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </th>
                                <th class="text-end">100%</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ===== CHART.JS ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prepare data for charts
    const currencyLabels = [];
    const currencyColors = [];
    const transactionCounts = [];
    const baseAmounts = [];
    
    {% for stat in currency_stats %}
    currencyLabels.push('{{ stat.currency }}');
    currencyColors.push('{{ stat.color }}');
    transactionCounts.push({{ stat.count }});
    baseAmounts.push({{ stat.base_amount }});
    {% endfor %}
    
    // Volume Chart
    const volumeCtx = document.getElementById('currencyVolumeChart');
    if (volumeCtx && currencyLabels.length > 0) {
        new Chart(volumeCtx, {
            type: 'bar',
            data: {
                labels: currencyLabels,
                datasets: [
                    {
                        label: 'Transactions',
                        data: transactionCounts,
                        backgroundColor: currencyColors.map(c => `${c}80`),
                        borderColor: currencyColors,
                        borderWidth: 1,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Value ({{ base_currency }})',
                        data: baseAmounts,
                        backgroundColor: currencyColors.map(c => `${c}40`),
                        borderColor: currencyColors,
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1',
                        tension: 0.3,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Transactions'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Value ({{ base_currency }})'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
    
    // Distribution Chart
    const distCtx = document.getElementById('valueDistributionChart');
    if (distCtx && baseAmounts.length > 0) {
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: currencyLabels,
                datasets: [{
                    data: baseAmounts,
                    backgroundColor: currencyColors,
                    borderColor: currencyColors.map(c => c + 'CC'),
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Initialize animations
    function initAnimations() {
        // Animate numbers
        const elements = document.querySelectorAll('.analytics-value-premium, .value-lg');
        elements.forEach(element => {
            const text = element.textContent;
            const match = text.match(/[\d,]+\.?\d*/);
            
            if (match) {
                const cleanText = match[0].replace(/,/g, '');
                const finalValue = parseFloat(cleanText) || 0;
                
                if (finalValue > 0) {
                    let startValue = 0;
                    const duration = 1000;
                    const startTime = Date.now();
                    
                    function updateNumber() {
                        const currentTime = Date.now();
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        const easeOutQuad = t => t * (2 - t);
                        const currentValue = Math.floor(easeOutQuad(progress) * finalValue);
                        
                        element.textContent = currentValue.toLocaleString();
                        
                        if (progress < 1) {
                            requestAnimationFrame(updateNumber);
                        }
                    }
                    
                    updateNumber();
                }
            }
        });
        
        // Add hover effects to cards
        document.querySelectorAll('.currency-card, .gradient-card, .analytics-card-premium').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-4px)';
                this.style.boxShadow = '0 10px 20px rgba(0,0,0,0.1)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });
        
        // Animate progress bars
        document.querySelectorAll('.progress-thin-bar').forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
                bar.style.transition = 'width 1.5s ease-in-out';
            }, 500);
        });
    }
    
    // Start animations after a delay
    setTimeout(initAnimations, 300);
});
</script>
{% endblock %}