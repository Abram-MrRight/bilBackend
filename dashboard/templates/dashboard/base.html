{% load static %}
{% load custom_filters %}
{% load form_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Bil Admin{% endblock %}</title>

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/enhanced-styles.css' %}">
<!-- Add this in the head section of your base.html or here -->
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'dashboard/css/base.css' %}">

</head>
<body>

<!-- Toasts -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3 toast-container">
    {% if messages %}
        {% for message in messages %}
            <div class="toast align-items-center text-white bg-success border-0 mb-2" role="alert" data-bs-delay="3000" data-bs-autohide="true">
                <div class="d-flex">
                    <div class="toast-body">{{ message }}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="logo position-relative">
        <span>Bil Admin</span>
        <button id="sidebar-toggle" aria-label="Toggle sidebar">
            <i class="bi bi-chevron-double-left"></i>
        </button>
    </div>

    <ul class="nav nav-pills flex-column mt-2">
        <li class="nav-item">
            <a href="{% url 'admin_dashboard' %}" 
            class="nav-link"
            data-url-name="admin_dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
        </li>   
        <li class="nav-item">
            <a href="{% url 'analytics_dashboard' %}" 
               class="nav-link {% if request.resolver_match.url_name == 'analytics_dashboard' %}active{% endif %}"
               data-url-name="analytics_dashboard">
                <i class="bi bi-bar-chart-line"></i>
                <span>Analytics</span>
            </a>
        </li>

        <li class="nav-item">
            <a href="{% url 'users' %}" 
               class="nav-link {% if 'users' in request.resolver_match.url_name %}active{% endif %}"
               data-url-name="users">
                <i class="bi bi-people"></i>
                <span>Users</span>
            </a>
        </li>

        <li class="nav-item">
            <a href="{% url 'admin_proofs' %}" 
               class="nav-link {% if 'proofs' in request.resolver_match.url_name %}active{% endif %}"
               data-url-name="admin_proofs">
                <i class="bi bi-file-earmark-text"></i>
                <span>Proofs</span>
            </a>
        </li>

        <li class="nav-item">
            <a href="{% url 'transactions' %}" 
               class="nav-link {% if 'transactions' in request.resolver_match.url_name %}active{% endif %}"
               data-url-name="transactions">
                <i class="bi bi-arrow-left-right"></i>
                <span>Transactions</span>
            </a>
        </li>

        <!-- Company Info Submenu -->
        <li class="nav-item has-submenu">
            <a class="nav-link d-flex justify-content-between align-items-center"
               href="#"
               data-bs-toggle="collapse"
               data-bs-target="#companySub"
               aria-expanded="false"
               aria-controls="companySub"
               data-url-name="company">
                <div class="d-flex align-items-center">
                    <i class="bi bi-building"></i>
                    <span>Company Info</span>
                </div>
                <i class="bi bi-chevron-down"></i>
            </a>
            <div class="collapse submenu" id="companySub">
                <a href="{% url 'company_info' %}" 
                   class="nav-link {% if 'company_info' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="company_info">
                    Company Information
                </a>
                <a href="{% url 'agents' %}" 
                   class="nav-link {% if 'agents' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="agents">
                    Agents
                </a>
                <a href="{% url 'proof_steps_list' %}" 
                   class="nav-link {% if 'proof_steps' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="proof_steps">
                    Upload Guide
                </a>
                <a href="{% url 'contacts_list' %}" 
                   class="nav-link {% if 'contacts' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="contacts">
                    WhatsApp Number
                </a>
            </div>
        </li>

        <!-- Settings Submenu -->
        <li class="nav-item has-submenu">
            <a class="nav-link d-flex justify-content-between align-items-center"
               href="#"
               data-bs-toggle="collapse"
               data-bs-target="#settingsSub"
               aria-expanded="false"
               aria-controls="settingsSub"
               data-url-name="settings">
                <div class="d-flex align-items-center">
                    <i class="bi bi-gear"></i>
                    <span>Settings</span>
                </div>
                <i class="bi bi-chevron-down"></i>
            </a>
            <div class="collapse submenu" id="settingsSub">
                <a href="{% url 'country_list' %}" 
                   class="nav-link {% if 'country' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="country">
                    Countries
                </a>
                <a href="{% url 'currency_list' %}" 
                   class="nav-link {% if 'currency' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="currency">
                    Currencies
                </a>
                <a href="{% url 'charge_rule_list' %}" 
                   class="nav-link {% if 'charge_rule' in request.resolver_match.url_name %}active{% endif %}"
                   data-url-name="charge_rule">
                    Charge Rules
                </a>
            </div>
        </li>

        <li class="nav-item">
            <a href="{% url 'exchange_rate_list' %}" 
               class="nav-link {% if 'exchange_rate' in request.resolver_match.url_name %}active{% endif %}"
               data-url-name="exchange_rate">
                <i class="bi bi-currency-exchange"></i>
                <span>Exchange Rate</span>
            </a>
        </li>
    </ul>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Topbar -->
    <div class="topbar">
        <div class="title">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard Overview
        </div>
        <div class="user-info dropdown">
            {% if request.user.is_authenticated %}
            <button class="btn btn-link text-decoration-none p-0 border-0 bg-transparent d-flex align-items-center gap-2"
                    id="userDropdown"
                    data-bs-toggle="dropdown">
                <div class="avatar-placeholder rounded-circle bg-gradient d-flex align-items-center justify-content-center"
                     style="width: 36px; height: 36px; background: linear-gradient(135deg, #1E7F7F, #4AC4C4);">
                    <i class="bi bi-person-fill text-white"></i>
                </div>
                <span class="text-white fw-medium">{{ request.user.fullname|default:request.user.username }}</span>
                <i class="bi bi-chevron-down text-white"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2" style="min-width: 200px;">
                <li><hr class="dropdown-divider"></li>
                <li>
                    <button class="dropdown-item d-flex align-items-center text-danger" data-bs-toggle="modal" data-bs-target="#logoutModal">
                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                    </button>
                </li>
            </ul>
            {% endif %}
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-wrapper">
        {% block content %}{% endblock %}
    </div>
</div>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger fw-semibold">
            <i class="bi bi-box-arrow-right me-2"></i>Confirm Logout
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
            <i class="bi bi-question-circle text-danger" style="font-size: 3rem;"></i>
        </div>
        <p class="mb-0 fs-5">Are you sure you want to log out?</p>
        <p class="text-muted small mt-2">You'll need to log in again to access the admin panel.</p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger px-4">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- JS -->
<script src="{% static 'dashboard/js/contact_list.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize toasts
    document.querySelectorAll('.toast').forEach(t => {
        const toast = new bootstrap.Toast(t);
        toast.show();
    });

    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');

    // Initialize tooltips for collapsed sidebar
    function initTooltips() {
        document.querySelectorAll('.sidebar .nav-link .tooltip-text').forEach(tooltip => {
            tooltip.remove();
        });
        
        if (sidebar.classList.contains('collapsed')) {
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                const text = link.querySelector('span')?.textContent || link.textContent;
                if (text && !link.querySelector('.tooltip-text')) {
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip-text';
                    tooltip.textContent = text.trim();
                    link.appendChild(tooltip);
                }
            });
        }
    }

    // Toggle sidebar
    toggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        sidebar.classList.toggle('collapsed');
        
        const icon = toggleBtn.querySelector('i');
        if (sidebar.classList.contains('collapsed')) {
            icon.classList.remove('bi-chevron-double-left');
            icon.classList.add('bi-chevron-double-right');
        } else {
            icon.classList.remove('bi-chevron-double-right');
            icon.classList.add('bi-chevron-double-left');
        }
        
        setTimeout(initTooltips, 300);
    });

    // Save and restore submenu states
    function saveSubmenuStates() {
        const submenuStates = {};
        document.querySelectorAll('.submenu').forEach(submenu => {
            const toggle = document.querySelector(`[data-bs-target="#${submenu.id}"]`);
            if (toggle) {
                submenuStates[submenu.id] = toggle.getAttribute('aria-expanded') === 'true';
            }
        });
        localStorage.setItem('submenuStates', JSON.stringify(submenuStates));
    }

    function restoreSubmenuStates() {
        const savedStates = localStorage.getItem('submenuStates');
        if (savedStates) {
            const submenuStates = JSON.parse(savedStates);
            Object.keys(submenuStates).forEach(submenuId => {
                const submenu = document.getElementById(submenuId);
                const toggle = document.querySelector(`[data-bs-target="#${submenuId}"]`);
                if (submenu && toggle) {
                    if (submenuStates[submenuId]) {
                        // Use Bootstrap's collapse API to show
                        const bsCollapse = new bootstrap.Collapse(submenu, {
                            toggle: false
                        });
                        bsCollapse.show();
                        toggle.setAttribute('aria-expanded', 'true');
                    }
                }
            });
        }
    }

    // Set active menu items based on current URL
function setActiveMenu() {
    const currentUrlName = '{{ request.resolver_match.url_name }}';
    const currentPath = window.location.pathname;
    
    // Remove all active classes first
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active', 'parent-active');
    });
    
    // Close all submenus first (but keep previously opened ones)
    document.querySelectorAll('.submenu').forEach(submenu => {
        // Only close if this submenu doesn't contain the active item
        const hasActiveChild = submenu.querySelector('.nav-link.active');
        if (!hasActiveChild && submenu.classList.contains('show')) {
            const bsCollapse = bootstrap.Collapse.getInstance(submenu);
            if (bsCollapse) {
                bsCollapse.hide();
            }
        }
    });
    
    // Special handling for dashboard (root path)
    if (currentUrlName === 'admin_dashboard' || currentPath === '/' || currentPath === '/admin/') {
        const dashboardLink = document.querySelector('.sidebar .nav-link[data-url-name="admin_dashboard"]');
        if (dashboardLink) {
            dashboardLink.classList.add('active');
            return; // Stop here, dashboard is active
        }
    }
    
    // Find and activate the correct menu item
    let activeFound = false;
    
    // First check top-level items without submenus
    document.querySelectorAll('.sidebar .nav-link[data-url-name]').forEach(link => {
        const urlName = link.getAttribute('data-url-name');
        const href = link.getAttribute('href');
        
        // Skip dashboard as we've already handled it
        if (urlName === 'admin_dashboard') return;
        
        // If this is a direct match
        if (urlName === currentUrlName) {
            link.classList.add('active');
            activeFound = true;
            
            // If this link is inside a submenu, open its parent
            const submenu = link.closest('.submenu');
            if (submenu) {
                const submenuId = submenu.id;
                const toggle = document.querySelector(`[data-bs-target="#${submenuId}"]`);
                if (toggle) {
                    const bsCollapse = new bootstrap.Collapse(submenu, {
                        toggle: false
                    });
                    bsCollapse.show();
                    toggle.setAttribute('aria-expanded', 'true');
                    saveSubmenuStates();
                }
            }
        }
    });
    
    // If no direct match found, check for partial matches
    if (!activeFound) {
        document.querySelectorAll('.sidebar .nav-link[data-url-name]').forEach(link => {
            const urlName = link.getAttribute('data-url-name');
            
            // Skip dashboard
            if (urlName === 'admin_dashboard') return;
            
            if (currentUrlName.includes(urlName) || urlName.includes(currentUrlName)) {
                link.classList.add('active');
                
                // If this link is inside a submenu, open its parent
                const submenu = link.closest('.submenu');
                if (submenu) {
                    const submenuId = submenu.id;
                    const toggle = document.querySelector(`[data-bs-target="#${submenuId}"]`);
                    if (toggle) {
                        const bsCollapse = new bootstrap.Collapse(submenu, {
                            toggle: false
                        });
                        bsCollapse.show();
                        toggle.setAttribute('aria-expanded', 'true');
                        saveSubmenuStates();
                    }
                }
            }
        });
    }
    
    // If nothing is active, activate dashboard (default)
    if (!activeFound && !document.querySelector('.sidebar .nav-link.active')) {
        const dashboardLink = document.querySelector('.sidebar .nav-link[data-url-name="admin_dashboard"]');
        if (dashboardLink) {
            dashboardLink.classList.add('active');
        }
    }
}

    // Initialize
    restoreSubmenuStates();
    setActiveMenu();
    initTooltips();

    // Handle submenu toggles
    document.querySelectorAll('.sidebar [data-bs-toggle="collapse"]').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const targetId = this.getAttribute('data-bs-target');
            const submenu = document.querySelector(targetId);
            
            if (submenu) {
                const bsCollapse = bootstrap.Collapse.getInstance(submenu) || 
                                  new bootstrap.Collapse(submenu, { toggle: false });
                
                bsCollapse.toggle();
                
                // Update aria-expanded attribute
                const isExpanded = submenu.classList.contains('show');
                this.setAttribute('aria-expanded', isExpanded);
                
                // Save state after animation
                setTimeout(saveSubmenuStates, 350);
            }
        });
        
        // Prevent link navigation for parent items
        toggle.addEventListener('dblclick', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    // Handle regular navigation clicks
    document.querySelectorAll('.sidebar .nav-link[href]:not([data-bs-toggle])').forEach(link => {
        link.addEventListener('click', function() {
            // Update active state immediately
            setActiveMenu();
            
            // Don't save submenu states here - let the page load naturally
        });
    });

    // Smooth hover effects
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('mouseenter', function() {
            if (!this.classList.contains('active') && !this.classList.contains('parent-active')) {
                this.style.transform = 'translateX(5px)';
            }
        });
        
        link.addEventListener('mouseleave', function() {
            if (!this.classList.contains('active') && !this.classList.contains('parent-active')) {
                this.style.transform = 'translateX(0)';
            }
        });
    });

    // Update topbar title based on active menu
    function updateTopbarTitle() {
        const activeLink = document.querySelector('.sidebar .nav-link.active');
        if (activeLink) {
            const titleText = activeLink.querySelector('span')?.textContent || 
                            activeLink.textContent;
            const topbarTitle = document.querySelector('.topbar .title');
            if (topbarTitle && titleText) {
                topbarTitle.innerHTML = `<i class="bi ${activeLink.querySelector('i')?.className || 'bi-speedometer2'} me-2"></i>${titleText}`;
            }
        }
    }
    
    // Initial update
    updateTopbarTitle();
    
    // Update when active menu changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (mutation.target.classList.contains('active')) {
                    updateTopbarTitle();
                }
            }
        });
    });
    
    // Observe all nav links for class changes
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        observer.observe(link, { attributes: true });
    });
});
</script>
{% block scripts %}{% endblock %}
</body>
</html>