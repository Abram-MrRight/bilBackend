{% extends 'dashboard/base.html' %}
{% load humanize %}
{% load static %}
{% load math_filters %}
{% block content %}
<!-- CSS -->
<link rel="stylesheet" href="{% static 'dashboard/css/admin_dashboard.css' %}">

<div class="container-fluid dashboard-container py-4">

    <!-- ===== EXECUTIVE HEADER ===== -->
    <div class="executive-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="fw-bold mb-2">Executive Dashboard</h1>
                <p class="lead opacity-85 mb-0">Real-time insights and analytics for bilSend platform management</p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="bg-white bg-opacity-10 backdrop-blur rounded-pill d-inline-flex align-items-center px-4 py-2">
                    <i class="bi bi-clock me-2"></i>
                    <span id="currentTime">{{ now|time:"H:i" }}</span>
                    <span class="mx-2 opacity-50">â€¢</span>
                    <span>{{ now|date:"l, j F Y" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== KPI METRICS ===== -->
    <div class="row g-4 mb-5 scroll-reveal">
        <div class="col-xl-3 col-md-6">
            <div class="metric-card bg-primary text-white animate-in">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label">Staff Users</div>
                            <div class="metric-number">{{ total_staff|intcomma }}</div>
                            <div class="small opacity-85 mt-2">
                                <i class="bi bi-arrow-up-right me-1"></i>
                                <span>Platform administrators</span>
                            </div>
                        </div>
                        <i class="bi bi-people-fill metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="metric-card bg-success text-white animate-in delay-1">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label">Active Clients</div>
                            <div class="metric-number">{{ total_clients|intcomma }}</div>
                            <div class="small opacity-85 mt-2">
                                <i class="bi bi-graph-up-arrow me-1"></i>
                                <span>Engaged users</span>
                            </div>
                        </div>
                        <i class="bi bi-person-check-fill metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="metric-card bg-danger text-white animate-in delay-2">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label">Total Proofs</div>
                            <div class="metric-number">{{ total_proofs|intcomma }}</div>
                            <div class="small opacity-85 mt-2">
                                <i class="bi bi-clock-history me-1"></i>
                                <span>Documents processed</span>
                            </div>
                        </div>
                        <i class="bi bi-file-earmark-check-fill metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="metric-card bg-warning text-white animate-in delay-2">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="metric-label">Total Transactions</div>
                            <div class="metric-number">{{ total_transactions|intcomma }}</div>
                            <div class="small opacity-85 mt-2">
                                <i class="bi bi-clock-history me-1"></i>
                                <span>Delivery Completed</span>
                            </div>
                        </div>
                        <i class="bi bi-file-earmark-check-fill metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== PROOF STATUS OVERVIEW ===== -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8 scroll-reveal">
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <h5 class="fw-bold mb-0">Weekly Proof Submissions</h5>
                        <small class="text-muted">Proof submission trends over the last 7 days</small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="bi bi-calendar-week me-1"></i> This Week
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-week me-2"></i>This Week</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-calendar me-2"></i>Last Week</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-month me-2"></i>This Month</a></li>
                        </ul>
                    </div>
                </div>
                <div id="proofChart-wrapper">
                    <canvas id="proofChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4 scroll-reveal">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3 text-uppercase">Proof Status Distribution</h6>
                    {% for status, count in proof_stats.items %}
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator me-3" 
                                 style="width: 12px; height: 12px; border-radius: 50%; 
                                        background: {% if status == 'Approved' %}#10b981{% elif status == 'Pending' %}#f59e0b{% elif status == 'Rejected' %}#ef4444{% else %}#6b7280{% endif %};">
                            </div>
                            <span class="fw-medium">{{ status }}</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold fs-5">{{ count|intcomma }}</span>
                            {% if total_proofs > 0 %}
                            <div class="text-muted small">
                                {{ count|floatformat:0 }}%
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="bi bi-pie-chart fs-1 text-muted mb-3 d-block"></i>
                        <p class="text-muted">No proof data available</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TOP ACTIVE CLIENTS ===== -->
    <div class="row g-4">
        <div class="col-lg-8 scroll-reveal">
            <div class="premium-table">
                <div class="table-header">
                    <h5><i class="bi bi-trophy"></i> Top Active Clients</h5>
                    <small class="opacity-75">Clients with highest proof submissions</small>
                </div>
                <div class="p-3">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr class="text-muted">
                                    <th style="width: 50px;">#</th>
                                    <th>Client</th>
                                    <th>Contact</th>
                                    <th class="text-end">Proofs</th>
                                    <th class="text-end">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in top_clients %}
                                <tr>
                                    <td class="text-muted fw-bold">{{ forloop.counter }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="client-avatar me-3">
                                                {{ c.fullname|first|upper }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ c.fullname }}</div>
                                                <div class="small text-muted">{{ c.email|truncatechars:20 }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ c.phone_number|default:"-" }}</td>
                                    <td class="text-end fw-bold">{{ c.proofs_count }}</td>
                                    <td class="text-end">
                                        {% if c.proofs_count > 20 %}
                                        <span class="badge-tier badge-vip">VIP</span>
                                        {% elif c.proofs_count > 10 %}
                                        <span class="badge-tier badge-active">Active</span>
                                        {% else %}
                                        <span class="badge-tier badge-new">New</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        <i class="bi bi-people fs-4 d-block mb-2"></i>
                                        No client activity found
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if top_clients %}
                    <div class="text-center mt-3">
                        <a href="{% url 'users' %}" class="btn btn-outline-primary btn-sm">
                            View All Clients <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ===== CHART.JS ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Chart
    initChart();
    
    // Initialize other features
    initDashboardFeatures();
});

function initChart() {
    const ctx = document.getElementById('proofChart');
    if (!ctx) return;
    
    // Destroy existing chart instance if exists
    if (window.proofChartInstance) {
        window.proofChartInstance.destroy();
    }
    
    // Generate gradient
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(30, 127, 127, 0.3)');
    gradient.addColorStop(1, 'rgba(30, 127, 127, 0.05)');
    
    window.proofChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ labels|safe }},
            datasets: [{
                label: 'Proofs Submitted',
                data: {{ week_data|safe }},
                borderColor: '#1E7F7F',
                backgroundColor: gradient,
                borderWidth: 3,
                tension: 0.35,
                fill: true,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: '#1E7F7F',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(26, 43, 60, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#1E7F7F',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `Proofs: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: { 
                        font: { size: 11 },
                        padding: 10,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                },
                x: {
                    grid: { 
                        display: false,
                        drawBorder: false
                    },
                    ticks: { 
                        font: { size: 11, weight: '500' },
                        padding: 10
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            layout: {
                padding: {
                    left: 10,
                    right: 10,
                    top: 10,
                    bottom: 10
                }
            },
            elements: {
                line: {
                    cubicInterpolationMode: 'monotone'
                }
            }
        }
    });
}

function initDashboardFeatures() {
    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = timeStr;
        }
    }

    // Initialize time and update every minute
    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);

    // Scroll reveal animation
    function handleScrollReveal() {
        const reveals = document.querySelectorAll('.scroll-reveal');
        reveals.forEach(element => {
            const windowHeight = window.innerHeight;
            const elementTop = element.getBoundingClientRect().top;
            const elementVisible = 150;
            
            if (elementTop < windowHeight - elementVisible) {
                element.classList.add('visible');
            }
        });
    }

    // Add hover animations to cards
    document.querySelectorAll('.metric-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Add hover animations to status tiles
    document.querySelectorAll('.status-tile').forEach(tile => {
        tile.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
        });
        
        tile.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Initialize scroll reveal
    window.addEventListener('scroll', handleScrollReveal);
    handleScrollReveal(); // Initial check

    // Handle window resize for chart
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (window.proofChartInstance) {
                window.proofChartInstance.resize();
            }
        }, 250);
    });

    // Animate numbers
    function animateNumbers() {
        const numbers = document.querySelectorAll('.metric-number');
        numbers.forEach(number => {
            const text = number.textContent;
            if (text && !isNaN(parseInt(text.replace(/,/g, '')))) {
                const finalValue = parseInt(text.replace(/,/g, ''));
                let startValue = 0;
                const duration = 1500;
                const startTime = Date.now();
                
                function updateNumber() {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeOutQuad = t => t * (2 - t);
                    const currentValue = Math.floor(easeOutQuad(progress) * finalValue);
                    
                    number.textContent = currentValue.toLocaleString();
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    }
                }
                
                updateNumber();
            }
        });
    }

    // Start number animation
    animateNumbers();
}
</script>
{% endblock %}